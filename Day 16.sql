DECLARE @input varchar(max)='\.-/...-\......../.|......|.........../..-..................|....-.\............................../...........
..........-.............\...\.........|..\.......................-..........-.......\.../.......-/............
........|.............-.....|..|........................\.\.../../.....-........................\.............
....../\.....................|........|.....-...........-..\......./-.............................-........./.
.\..\.............-........|.......|...|..............................-..-......-......|......................
..........|/...\.............\............../-......\.../........................./............./.../......../
..............\......./..-...............|...........\...|............|...........-..-............|...........
..........-...............|..././...........................................|...........-.../.-.|.....|.......
.........-...|..................-...........\.-...................../.../........................|/......./...
.................................-.././...................|\..............|.........../.......................
.............../......-.................\....--.....-............................./.|./.................|.....
..../....|...|..................../....\...|............|...../.././../--......\.\....|.......-............\./
......\....-...|......\...........-......./..................../.....-..............\.............|......./...
............|.\...................|.........................|........\............................./.\.......|
............../...............................|.........../.................\-.................../........../.
.|....|...........|..................|......./|\\.|\.-...\..../.........//........|............../...........|
........................|.....--......|.............-..................\...../..../.......-....|...\..........
...............\........-........../...-|............\......./.\...........-|................/.-..............
..../....|.\.............|......|...............................................|.................\...........
.\...\......./.....|.\....|..................-../|-......................|.................-..|......\........
.../.........................................\.....././....................|.......-........-......\....|.....
.................\./\..-../......../...\................................-......-..\...........................
.......--..-........\/........./........../...............\..............\...-........-......-../.........|...
.|...............-........./..............\..\......................|......./..|..............-.......|.|.....
........./............\............|........\...|...\........-.......................|...................\....
..................-\......../.................\.......\.....|...........|..|-........\.............|.......\\.
...|.........../.......|...../...|...\........\\...................................-............-../...../....
......./....................|.........../...-................-....................\.......|...................
\....\.......................-.|.\...../..-...................|......................-..................../...
......|........-|...-/.|........................./.....|.....\.........-........-......-.............././.....
......|.............-.\...............................\..|....\..............|./..|./...\......./..........|\|
......././.\...................-...-............/...................|/..........-\./.................|........
.........|..........|\../.........\..............-.........\................../\./.............-..............
...\.......................\..................................\...........................................|...
...|........\..........|....|..../..|.........-\.................-...-..\.\.........\............|....|...//..
.././.....|.....-..........|.................\.........\........./......-...-.\.\.....................\.......
......./....\........\\..\...|...../.................|.......|.\.....\............................../\....\...
.........\......../.\............|...............................................................|/...........
.\.....-\-.........|.........|....|...........-....\.....|................\...............-............./.....
.....-..............................-.....-..........-..................../..../........................|.....
...........\...........-/....................-.....-............/........|........-/.........--./........-..\\*
.|................................................|..................-.......|.............|\/................
.|.................-.-..........|.........................../..../....../.....\...../......./.................
........./..../..|..........\..................\....................................................../.......
.........\............|.../......../........|......................../..../...|.\...\......................|..
........./................\.............\........|....................\./......|.........-....../...../.......
..../.....|...../........-...................|............/.....||...............-....-.-.....................
\./...\.|...|.............|.......\....../|...\\/.|.../....-.........\\|..|....-........\............-.......|
......\-..............|.....\.....|...\..............................|.....................\......-.....|.....
......\.-..........-..|......................................-..../......................../........\.......|.
/...................-...\.........--.............................\...........\................|......./.......
.................-......-..../..\.............-./|......-....\...........-...................\.....|........-.
|........--.............\...-....|.......|.\............|...../\...........\/../............................-.
...|./-..\.|...........\........../..............................\......-.......-.....|..........-........./..
.......-|..................-..........|..-............................../.............|..|.||.................
....-......................\....\..................\......./............./..-........|..............-....|....
-..........-.........-.../|........--.............-................|..../|.................|..................
...\......./..\..\......./|.....|-.............-............................\..\......\...-..\...............\*
./......................|..........\...........|.|.......\..........\......................................\..
................|...............-.../....\......./.\........-..............................|...-....-.........
..\.......................\..../..|.-.........-.............\.......|../.|.|..|........|..............-.......
...........\................\..........................\.....................\........|.......................
..........|....\.......\...........|...../......................................./...\.../........../.........
./...............\...........|..-....-./..\...\...\../...............-\............\....\............-........
././............|................|........../...\...../.............-....-.............\......................
....-.|..................../.............................-...............................|....................
..-......|....-.........-...\......\.........||....-.\............................-...|..............|........
........\...........\.-.......\.../.........\.../.....|.................../..|..|....\..../..-................
..........-..................\..|...|.|..\......................./...........-......./.............|..\...../.
.\......|\.|..\.......|\.-.......-........../........../..........\.........../.........|.....................
./..........|..................//.|......|........-...\...//............-.../..............|.......-....-.....
...............\......\........|.-................\......-...................|.............-............-.-...
...........................\/...........\../..\....................\...........|.............-..........-.....
.............../........\|.........\..........-......../............-..........|........|/....................
....\................-..................././........|.....|...........................-..|....................
\-............-.......\......\.................../.......-.../............/....-..\.......|................|..
.........................../....../.|...\/...\........-|.|.......\..-........-............................../.
.................\.....................|..........|.............|......|/.\..........................-........
....\../................................|.......-......|.................-......................|...-.../.....
....-.........|..../|..............................-|...............................-..-......\.....-.........
./\...............|.|..............-./..|........./...................................................\.......
..............-....\..|....../.....\.............\..............................-...-..../.....|..............
........-.........|..............................................-....\--...........|\...................../..
................/.|.................-....|......./............-...................../.-./\................|...
................|............................../..-./.....|..-........................./.....|..............-.
....../........../.......|...|.....\........./.............|..................................|.|.............
....................................................||.....|................/......-....../....../............
.........../.....\...................|...........\../....................................../.............../..
./.|............../.............................\..|....\-............./......................................
.........\................../-.....|...........\................|...../..................................|....
..|...../.....|...............\.....-.................................|/............-..|..-...|......-........
....|....-..............|.......|............./\-...........\//.........|...........\...../..............--...
.............-........\|...........................-....../....||............/......./....................../.
|..................-......\.........-.......|..............................\.|/..................\......\.-...
....../.......................|........|..|.\...........|.........\................\\..................\.../..
...........-....|...........||...-.......|.|....-.....\\-................|.........../..................\/....
................|.-.................|-./..-..|.........-..............-.........-../........................-.
.....................-.....................................|.........\......||./................|.............
............/...-............|......./......................................../..........................-....
..../.......\.-............|..........|....-...........\.-.................................\./...|............
...........|.-........|.|....-...........\......-...-..........|.\.|.|.....\....\............../..............
......\...\....../....\......\.|......................./.......................\.................../..../\....
...../.|...............|.../\.........................................-...........|./........................|
.........................-.-.......\./..........|.........|/.......-......................-...-..|\|........\.
..................|......-..................|..........\..-../........................-......\...\............
..|...............\.............../.........-./............../.../..../.|\......\..../-.....|....-.........|..
...-..-..............--...|...................................................|.-.../.../.....\.....\.........
.\./.../..............././.........\.........|..\..........\.................\..|.....-......-................
......-...................|../....................|...............|.............|/..\.......|........\......|.
......\/.....|................./..................................|.......|./........|.............-...-......';

/*
SET @input='.|...\....
|.-.\.....
.....|-...
........|.
..........
.........\*
..../.\\..
.-.-/..|..
.|....-|.\*
..//.|....';
*/

SET @input=REPLACE(@input, '*', '');

DECLARE @width tinyint=PATINDEX('%['+CHAR(10)+CHAR(13)+']%', @input)-1;

SET @input=REPLACE(REPLACE(@input, CHAR(13), ''), CHAR(10), '');

DECLARE @height tinyint=LEN(@input)/@width;

IF (LEN(@input)!=CAST(@width AS int)*CAST(@height AS int)) THROW 50001, 'Something''s not right.', 1;








--- Part 1:


/*

DROP TABLE IF EXISTS #coordinates;

CREATE TABLE #coordinates (
    x           tinyint NOT NULL,
    y           tinyint NOT NULL,
    dir         char(1) NOT NULL,
    iteration   smallint NOT NULL,
    PRIMARY KEY CLUSTERED (x, y, dir)
);

DECLARE @iteration smallint=1;

INSERT INTO #coordinates (x, y, dir, iteration)
VALUES (0, 1, 'E', @iteration);

WHILE (@@ROWCOUNT>0) BEGIN;

    SET @iteration=@iteration+1;

    WITH cte AS (
        SELECT x, y, dir, 0 AS recursion
        FROM #coordinates
        WHERE iteration=@iteration-1

        UNION ALL

        SELECT CAST(d.x AS tinyint), CAST(d.y AS tinyint), CAST(d.dir AS char(1)), recursion+1
        FROM cte
        CROSS APPLY (
            VALUES (ISNULL(NULLIF(SUBSTRING(@input, @width*(y-1)+x, 1), ''), '.'))
        ) AS m(mirror)
        CROSS APPLY (
            SELECT x+1 AS x, y, 'E' AS dir WHERE cte.dir='E' AND m.mirror IN ('.', '-') OR
                                                 cte.dir='N' AND m.mirror IN ('/', '-') OR
                                                 cte.dir='S' AND m.mirror IN ('\', '-')
            UNION ALL
            SELECT x-1 AS x, y, 'W' AS dir WHERE cte.dir='W' AND m.mirror IN ('.', '-') OR
                                                 cte.dir='N' AND m.mirror IN ('\', '-') OR
                                                 cte.dir='S' AND m.mirror IN ('/', '-')
            UNION ALL
            SELECT x, y-1 AS y, 'N' AS dir WHERE cte.dir='N' AND m.mirror IN ('.', '|') OR
                                                 cte.dir='W' AND m.mirror IN ('\', '|') OR
                                                 cte.dir='E' AND m.mirror IN ('/', '|')
            UNION ALL
            SELECT x, y+1 AS y, 'S' AS dir WHERE cte.dir='S' AND m.mirror IN ('.', '|') OR
                                                 cte.dir='W' AND m.mirror IN ('/', '|') OR
                                                 cte.dir='E' AND m.mirror IN ('\', '|')
        ) AS d
        WHERE d.x BETWEEN 1 AND @width
        AND d.y BETWEEN 1 AND @height
        AND cte.recursion<100
)

INSERT INTO #coordinates (x, y, dir, iteration)
SELECT DISTINCT x, y, dir, @iteration
FROM cte
WHERE x!=0
  AND NOT EXISTS (
    SELECT NULL FROM #coordinates
    WHERE x=cte.x AND y=cte.y AND dir=cte.dir)
OPTION (MAXRECURSION 1000);

END;


SELECT COUNT(*) FROM (
    SELECT DISTINCT x, y
    FROM #coordinates
    WHERE x>0) AS sub;

*/





--- Part 2:


DROP TABLE IF EXISTS #coordinates;

CREATE TABLE #coordinates (
    start_dir   char(1) NOT NULL,
    x           tinyint NOT NULL,
    y           tinyint NOT NULL,
    dir         char(1) NOT NULL,
    iteration   smallint NOT NULL,
    PRIMARY KEY CLUSTERED (start_dir, x, y, dir)
);

DROP TABLE IF EXISTS #history;

CREATE TABLE #history (
    start_x     tinyint NOT NULL,
    start_y     tinyint NOT NULL,
    start_dir   char(1) NOT NULL,
    [count]     int NOT NULL,
    PRIMARY KEY CLUSTERED (start_x, start_y)
);

DECLARE @start_x tinyint=0, @start_y tinyint=1;
DECLARE @iteration smallint=1;

WHILE (@start_x IS NOT NULL) BEGIN;

    SET @iteration=1;
    PRINT 'Starting: x='+STR(@start_x, 3, 0)+'y='+STR(@start_y, 3, 0);

    TRUNCATE TABLE #coordinates;

    INSERT INTO #coordinates (start_dir, x, y, dir, iteration)
    SELECT start_dir, @start_x, @start_y, start_dir AS dir, @iteration
    FROM (
        SELECT 'E' AS start_dir WHERE @start_x=0
        UNION ALL
        SELECT 'N' AS start_dir WHERE @start_y=@height+1
        UNION ALL
        SELECT 'W' AS start_dir WHERE @start_x=@width+1
        UNION ALL
        SELECT 'S' AS start_dir WHERE @start_y=0
    ) AS dir;

    WHILE (@@ROWCOUNT>0) BEGIN;

        SET @iteration=@iteration+1;

        WITH cte AS (
            SELECT start_dir, x, y, dir, 0 AS recursion
            FROM #coordinates
            WHERE iteration=@iteration-1

            UNION ALL

            SELECT cte.start_dir, CAST(d.x AS tinyint), CAST(d.y AS tinyint), CAST(d.dir AS char(1)), recursion+1
            FROM cte
            CROSS APPLY (
                VALUES (ISNULL(NULLIF(SUBSTRING(@input, @width*(y-1)+x, 1), ''), '.'))
            ) AS m(mirror)
            CROSS APPLY (
                SELECT x+1 AS x, y, 'E' AS dir WHERE cte.dir='E' AND m.mirror IN ('.', '-') OR
                                                     cte.dir='N' AND m.mirror IN ('/', '-') OR
                                                     cte.dir='S' AND m.mirror IN ('\', '-')
                UNION ALL
                SELECT x-1 AS x, y, 'W' AS dir WHERE cte.dir='W' AND m.mirror IN ('.', '-') OR
                                                     cte.dir='N' AND m.mirror IN ('\', '-') OR
                                                     cte.dir='S' AND m.mirror IN ('/', '-')
                UNION ALL
                SELECT x, y-1 AS y, 'N' AS dir WHERE cte.dir='N' AND m.mirror IN ('.', '|') OR
                                                     cte.dir='W' AND m.mirror IN ('\', '|') OR
                                                     cte.dir='E' AND m.mirror IN ('/', '|')
                UNION ALL
                SELECT x, y+1 AS y, 'S' AS dir WHERE cte.dir='S' AND m.mirror IN ('.', '|') OR
                                                     cte.dir='W' AND m.mirror IN ('/', '|') OR
                                                     cte.dir='E' AND m.mirror IN ('\', '|')
            ) AS d
            WHERE d.x BETWEEN 1 AND @width
            AND d.y BETWEEN 1 AND @height
            AND cte.recursion<50                --- Tweak this number for optimal performance.
        )

        INSERT INTO #coordinates (start_dir, x, y, dir, iteration)
        SELECT DISTINCT start_dir, x, y, dir, @iteration
        FROM cte
        WHERE x!=0
        AND NOT EXISTS (
            SELECT NULL FROM #coordinates
            WHERE start_dir=cte.start_dir AND x=cte.x AND y=cte.y AND dir=cte.dir)
        OPTION (MAXRECURSION 1000);

    END;

    INSERT INTO #history (start_x, start_y, start_dir, [count])
    SELECT @start_x, @start_y, start_dir, COUNT(*)
    FROM (
        SELECT DISTINCT start_dir, x, y
        FROM #coordinates
        WHERE x>0
        ) AS sub
    GROUP BY start_dir;

    --- That's odd.
    IF (@@ROWCOUNT=0)
        INSERT INTO #history (start_x, start_y, start_dir, [count])
        VALUES (@start_x, @start_y, '?', 0);

    PRINT 'Done:     x='+STR(@start_x, 3, 0)+'y='+STR(@start_y, 3, 0)+'.';

    SELECT @start_x=NULL, @start_y=NULL;

    SELECT TOP (1) @start_x=start_x, @start_y=start_y
    FROM (
        SELECT start_x, start_y
        FROM (
            SELECT [value] AS start_x, 0 AS start_y FROM GENERATE_SERIES(1, CAST(@width AS int), 1)
            UNION ALL
            SELECT [value] AS start_x, @height+1 AS start_y FROM GENERATE_SERIES(1, CAST(@width AS int), 1)
            UNION ALL
            SELECT 0 AS start_x, [value] AS start_y FROM GENERATE_SERIES(1, CAST(@height AS int), 1)
            UNION ALL
            SELECT @width+1 AS start_x, [value] AS start_y FROM GENERATE_SERIES(1, CAST(@height AS int), 1)
        ) AS d
        EXCEPT
        SELECT start_x, start_y
        FROM #history
    ) AS sub;

END;



--- Part 1:

SELECT *
FROM #history
WHERE start_x=0 AND start_y=1 AND start_dir='E';

--- Part 2:

SELECT TOP (1) WITH TIES [count]-1
FROM #history
ORDER BY [count] DESC;


